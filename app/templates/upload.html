{% extends "base.html" %}

{% block title %}PIXText - Upload de Comprovantes{% endblock %}

{% block content %}
    <!-- Main Content - Extraction Tool -->
    <section class="px-4 md:px-8 py-12 md:py-20">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold mb-4">
                    <span class="text-highlight">Extra√ß√£o</span> de <span class="text-primary">Comprovantes PIX</span>
                </h1>
                <p class="text-xl text-gray-300 max-w-2xl mx-auto">
                    Fa√ßa upload do seu comprovante PIX e veja a magia acontecer. Nossa IA extrai automaticamente todas as informa√ß√µes importantes.
                </p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Left Column - Upload Area -->
                <div class="wave-animation">
                    <div class="bg-gradient-to-br from-gray-800 via-dark-800 to-gray-800 border border-gray-700 rounded-2xl p-8 shadow-xl">
                        <h2 class="text-2xl font-bold mb-2">üì§ Envie seu comprovante PIX</h2>
                        <p class="text-gray-400 mb-6">Arraste e solte ou clique para fazer upload do seu recibo</p>
                        
                        <div id="drop-area" class="file-drop-area rounded-xl p-12 mb-8 text-center cursor-pointer transition-colors">
                            <div class="floating inline-flex flex-col items-center justify-center">
                                <i class="fas fa-cloud-upload-alt text-5xl text-primary mb-4"></i>
                                <h3 class="text-xl font-medium mb-1">Arraste seu arquivo aqui</h3>
                                <p class="text-gray-400 mb-4">ou clique para selecionar</p>
                            </div>
                            <input type="file" id="file-input" class="hidden" accept="image/*, .pdf">
                            <button id="upload-btn" class="px-5 py-2.5 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                <i class="fas fa-folder-open mr-2"></i>Selecionar Arquivo
                            </button>
                            <p class="text-sm text-gray-500 mt-4">üìã Formatos: JPG, PNG, PDF ‚Ä¢ üîí M√°x: 16MB</p>
                        </div>
                        
                        <div id="file-preview" class="hidden mb-6">
                            <h3 class="text-lg font-medium mb-4">üîç Pr√©-visualiza√ß√£o:</h3>
                            <div class="relative border-2 border-dashed border-gray-600 rounded-xl overflow-hidden bg-gray-900 aspect-video flex items-center justify-center">
                                <img id="preview-image" class="max-h-64 object-contain">
                                <div id="pdf-preview" class="hidden flex-col items-center justify-center p-4">
                                    <i class="fas fa-file-pdf text-5xl text-red-500 mb-3"></i>
                                    <p id="pdf-name" class="font-medium max-w-full truncate"></p>
                                    <p class="text-sm text-gray-400 mt-1">üìÑ Documento PDF pronto para extra√ß√£o</p>
                                </div>
                                <button id="remove-file" class="absolute top-3 right-3 p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="progress-container" class="hidden mb-6">
                            <div class="flex justify-between mb-2">
                                <span class="font-medium">üîÑ Processando com OCR + ML + YOLO...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="bg-gray-700 rounded-full h-2">
                                <div class="progress-bar rounded-full"></div>
                            </div>
                            <div class="mt-2 text-sm text-gray-400">
                                <span id="progress-step">Iniciando processamento...</span>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <button id="extract-btn" class="w-full py-4 bg-gradient-to-r from-primary to-secondary rounded-xl font-semibold text-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-bolt mr-2"></i>üöÄ Extrair com IA Agora
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-900 rounded-lg">
                            <h4 class="font-semibold mb-2">ü§ñ Tecnologias Utilizadas:</h4>
                            <div class="flex flex-wrap gap-2 text-sm">
                                <span class="bg-blue-900 text-blue-300 px-2 py-1 rounded">Tesseract OCR</span>
                                <span class="bg-green-900 text-green-300 px-2 py-1 rounded">EasyOCR</span>
                                <span class="bg-purple-900 text-purple-300 px-2 py-1 rounded">YOLOv8</span>
                                <span class="bg-orange-900 text-orange-300 px-2 py-1 rounded">Scikit-learn</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column - Results Area -->
                <div>
                    <div class="result-card rounded-2xl p-8 shadow-xl">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">üìä Resultados da Extra√ß√£o</h2>
                            <div class="bg-gray-800 text-primary px-3 py-1 rounded-full text-sm">
                                <i class="fas fa-magic mr-2"></i>IA Avan√ßada
                            </div>
                        </div>
                        
                        <div id="result-empty" class="flex flex-col items-center justify-center py-16 text-center">
                            <i class="fas fa-file-invoice text-6xl text-primary mb-6 opacity-30"></i>
                            <h3 class="text-xl font-medium mb-2">‚ú® Aguardando Comprovante</h3>
                            <p class="text-gray-400 max-w-xs">
                                Envie um comprovante PIX para extrair automaticamente informa√ß√µes como valor, destinat√°rio, data e muito mais.
                            </p>
                            
                            <div class="mt-6 p-4 bg-gray-900 rounded-lg text-left">
                                <h4 class="font-semibold mb-2">üéØ O que extra√≠mos:</h4>
                                <ul class="text-sm space-y-1 text-gray-300">
                                    <li>üí∞ Valor da transa√ß√£o</li>
                                    <li>üë§ Nome do destinat√°rio</li>
                                    <li>üì± CPF/CNPJ</li>
                                    <li>üè¶ Banco de origem/destino</li>
                                    <li>üìÖ Data e hor√°rio</li>
                                    <li>üî¢ ID da transa√ß√£o</li>
                                    <li>üè∑Ô∏è Tipo de opera√ß√£o</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div id="result-content" class="hidden">
                            <div class="bg-gray-900 p-6 rounded-xl mb-6">
                                <div class="flex flex-wrap gap-3 mb-5">
                                    <span class="bg-green-900 text-green-300 px-3 py-1 rounded-lg text-sm">
                                        <i class="fas fa-check-circle mr-1"></i> ‚úÖ Valida√ß√£o OK
                                    </span>
                                    <span class="bg-blue-900 text-blue-300 px-3 py-1 rounded-lg text-sm">
                                        <i class="fas fa-bolt mr-1"></i> ‚ö° Processado em <span id="processing-time">1.8s</span>
                                    </span>
                                    <span class="bg-purple-900 text-purple-300 px-3 py-1 rounded-lg text-sm">
                                        <i class="fas fa-brain mr-1"></i> üß† Banco: <span id="detected-bank">Auto-detectado</span>
                                    </span>
                                </div>
                                
                                <div class="space-y-4" id="extracted-data">
                                    <!-- Dados ser√£o inseridos dinamicamente aqui -->
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-medium">üìÑ Texto Completo Extra√≠do:</h3>
                                    <button id="copy-text" class="px-3 py-1 bg-gray-700 rounded-lg text-sm hover:bg-gray-600 transition">
                                        <i class="fas fa-copy mr-1"></i>Copiar
                                    </button>
                                </div>
                                <div class="bg-gray-900 rounded-xl p-5 text-sm font-mono max-h-56 overflow-auto" id="full-text">
                                    <!-- Texto completo ser√° inserido aqui -->
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button id="download-json" class="py-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition">
                                    <i class="fas fa-download mr-2"></i>üìÑ JSON
                                </button>
                                <button id="download-txt" class="py-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition">
                                    <i class="fas fa-file-alt mr-2"></i>üìù TXT
                                </button>
                                <button id="extract-another" class="py-3 bg-gradient-to-r from-secondary to-primary rounded-lg hover:opacity-90 transition">
                                    <i class="fas fa-sync mr-2"></i>üîÑ Extrair Outro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
// ...existing code from the original index.html with PIX-specific modifications...
document.addEventListener('DOMContentLoaded', function() {
    // Upload functionality with enhanced features
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const filePreview = document.getElementById('file-preview');
    const previewImage = document.getElementById('preview-image');
    const pdfPreview = document.getElementById('pdf-preview');
    const pdfName = document.getElementById('pdf-name');
    const removeFile = document.getElementById('remove-file');
    const extractBtn = document.getElementById('extract-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressPercent = document.getElementById('progress-percent');
    const progressStep = document.getElementById('progress-step');
    const progressBar = document.querySelector('.progress-bar');
    const resultEmpty = document.getElementById('result-empty');
    const resultContent = document.getElementById('result-content');
    
    // Enhanced steps for progress
    const processingSteps = [
        'Carregando arquivo...',
        'Detectando regi√µes com YOLO...',
        'Aplicando OCR (Tesseract)...',
        'Refinando com EasyOCR...',
        'Classificando banco (ML)...',
        'Estruturando dados...',
        'Finalizando extra√ß√£o...'
    ];
    
    let currentFile = null;
    
    // Upload button click
    uploadBtn.addEventListener('click', () => fileInput.click());
    
    // File input change
    fileInput.addEventListener('change', handleFileSelection);
    
    // Enhanced drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.classList.add('drag-over');
    }
    
    function unhighlight() {
        dropArea.classList.remove('drag-over');
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    function handleFileSelection() {
        const files = fileInput.files;
        handleFiles(files);
    }
    
    function handleFiles(files) {
        if (files.length === 0) return;
        
        const file = files[0];
        const fileType = file.type;
        
        // Enhanced validation
        if (!fileType.match(/(image\/(jpeg|jpg|png|gif|bmp|tiff)|application\/pdf)/)) {
            alert('‚ùå Por favor, envie um arquivo de imagem (JPG, PNG, GIF, BMP, TIFF) ou PDF.');
            return;
        }
        
        if (file.size > 16 * 1024 * 1024) { // 16MB
            alert('‚ùå Arquivo muito grande! M√°ximo: 16MB');
            return;
        }
        
        currentFile = file;
        
        if (fileType.includes('image')) {
            displayImagePreview(file);
        } else {
            displayPdfPreview(file);
        }
        
        extractBtn.disabled = false;
    }
    
    function displayImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.classList.remove('hidden');
            pdfPreview.classList.add('hidden');
            filePreview.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    }
    
    function displayPdfPreview(file) {
        pdfName.textContent = file.name;
        pdfPreview.classList.remove('hidden');
        previewImage.classList.add('hidden');
        filePreview.classList.remove('hidden');
    }
    
    // Remove file
    removeFile.addEventListener('click', () => {
        fileInput.value = '';
        filePreview.classList.add('hidden');
        extractBtn.disabled = true;
        currentFile = null;
    });
    
    // Enhanced extraction with real API call
    extractBtn.addEventListener('click', async () => {
        if (!currentFile) return;
        
        // Show progress
        progressContainer.classList.remove('hidden');
        extractBtn.disabled = true;
        
        // Create FormData
        const formData = new FormData();
        formData.append('file', currentFile);
        
        try {
            // Simulate realistic progress
            await simulateProgress();
            
            // Make actual API call
            const response = await fetch('/api/extract', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Erro na extra√ß√£o');
            }
            
            const result = await response.json();
            displayResults(result);
            
        } catch (error) {
            console.error('Erro:', error);
            alert('‚ùå Erro durante a extra√ß√£o. Tente novamente.');
        } finally {
            progressContainer.classList.add('hidden');
            extractBtn.disabled = false;
        }
    });
    
    async function simulateProgress() {
        for (let i = 0; i < processingSteps.length; i++) {
            const progress = Math.round(((i + 1) / processingSteps.length) * 100);
            progressBar.style.width = progress + '%';
            progressPercent.textContent = progress + '%';
            progressStep.textContent = processingSteps[i];
            
            await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 400));
        }
    }
    
    function displayResults(data) {
        resultEmpty.classList.add('hidden');
        resultContent.classList.remove('hidden');
        
        // Update processing info
        document.getElementById('processing-time').textContent = data.processing_time || '2.1s';
        document.getElementById('detected-bank').textContent = data.banco_detectado || 'Auto-detectado';
        
        // Display extracted data
        const extractedDataContainer = document.getElementById('extracted-data');
        extractedDataContainer.innerHTML = generateDataHTML(data.dados_extraidos || data);
        
        // Display full text
        document.getElementById('full-text').textContent = data.texto_completo || 'Texto extra√≠do n√£o dispon√≠vel';
        
        // Setup download buttons
        setupDownloadButtons(data);
    }
    
    function generateDataHTML(data) {
        return `
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-1">üí∞ VALOR:</h4>
                <p class="text-xl font-bold">${data.valor || 'N/A'}</p>
            </div>
            
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-1">üë§ DESTINAT√ÅRIO:</h4>
                <p class="text-lg">${data.destinatario?.nome || 'N/A'}</p>
                <p class="text-gray-400">${data.destinatario?.cpf || data.destinatario?.cnpj || 'N/A'}</p>
            </div>
            
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-1">üè¶ REMETENTE:</h4>
                <p class="text-lg">${data.remetente?.nome || 'N/A'}</p>
                <p class="text-gray-400">${data.remetente?.instituicao || 'N/A'}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h4 class="text-sm font-semibold text-gray-400 mb-1">üìÖ DATA:</h4>
                    <p>${data.data || 'N/A'} ${data.horario || ''}</p>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-400 mb-1">üî¢ TRANSA√á√ÉO:</h4>
                    <p class="text-sm break-all">${data.id_transacao || 'N/A'}</p>
                </div>
            </div>
        `;
    }
    
    function setupDownloadButtons(data) {
        document.getElementById('download-json').onclick = () => {
            downloadFile(JSON.stringify(data, null, 2), 'comprovante.json', 'application/json');
        };
        
        document.getElementById('download-txt').onclick = () => {
            downloadFile(data.texto_completo || '', 'comprovante.txt', 'text/plain');
        };
        
        document.getElementById('copy-text').onclick = () => {
            navigator.clipboard.writeText(data.texto_completo || '').then(() => {
                alert('‚úÖ Texto copiado!');
            });
        };
        
        document.getElementById('extract-another').onclick = () => {
            location.reload();
        };
    }
    
    function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
});
</script>
{% endblock %}
