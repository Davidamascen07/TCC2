<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIXText - Chatbot Inteligente para Comprovantes PIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        secondary: '#3b82f6',
                        dark: '#0f172a',
                        'dark-800': '#1e293b'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'fade-in': 'fadeIn 0.3s ease-in'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .chat-container {
            height: calc(100vh - 200px);
            min-height: 500px;
        }
        
        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: #8b5cf6 #1e293b;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 3px;
        }
        
        .message-user {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
        }
        
        .message-bot {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .file-drop-mini {
            border: 2px dashed #8b5cf6;
            transition: all 0.3s ease;
        }
        
        .file-drop-mini:hover {
            background-color: rgba(139, 92, 246, 0.1);
            border-color: #3b82f6;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        .extracted-data {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }
        
        .nav-active {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    <!-- Header Section -->
    <header class="py-4 px-4 md:px-8 border-b border-gray-800">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="bg-gradient-to-r from-primary to-secondary w-10 h-10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold ml-3 tracking-tight">PIXText<span class="text-secondary">.ai</span></h1>
                <span class="ml-3 px-2 py-1 bg-green-600 text-xs rounded-full">
                    <i class="fas fa-circle text-xs mr-1 animate-pulse"></i>Online
                </span>
            </div>
            
            <nav class="flex space-x-1 md:space-x-6">
                <a href="{{ url_for('main.index') }}" class="px-4 py-2 rounded-lg hover:bg-gray-800 transition {% if request.endpoint == 'main.index' %}nav-active{% endif %}">
                    <i class="fas fa-home mr-2"></i>In√≠cio
                </a>
                <a href="{{ url_for('main.upload_page') }}" class="px-4 py-2 rounded-lg hover:bg-gray-800 transition {% if request.endpoint == 'main.upload_page' %}nav-active{% endif %}">
                    <i class="fas fa-upload mr-2"></i>Upload
                </a>
                <a href="{{ url_for('main.chatbot_page') }}" class="px-4 py-2 rounded-lg hover:bg-gray-800 transition {% if request.endpoint == 'main.chatbot_page' %}nav-active{% endif %}">
                    <i class="fas fa-robot mr-2"></i>Chatbot
                </a>
                <a href="{{ url_for('main.analytics_page') }}" class="px-4 py-2 rounded-lg hover:bg-gray-800 transition {% if request.endpoint == 'main.analytics_page' %}nav-active{% endif %}">
                    <i class="fas fa-chart-bar mr-2"></i>Analytics
                </a>
                <a href="#" class="px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                    <i class="fas fa-book mr-2"></i>API
                </a>
            </nav>
            
            <div class="mt-4 md:mt-0">

            </div>
        </div>
    </header>

    <!-- Main Chat Interface -->
    <main class="px-4 md:px-8 py-6">
        <div class="max-w-6xl mx-auto">
            <!-- Chat Container -->
            <div class="bg-gradient-to-br from-gray-800 via-dark-800 to-gray-800 border border-gray-700 rounded-2xl shadow-2xl overflow-hidden">
                
                <!-- Chat Header -->
                <div class="bg-dark-800 border-b border-gray-700 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-xl"></i>
                            </div>
                            <div class="ml-3">
                                <h2 class="text-lg font-semibold">Assistente PIX</h2>
                                <p class="text-sm text-green-400">
                                    <i class="fas fa-circle text-xs mr-1"></i>Pronto para ajudar
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <button id="clear-chat" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages Area -->
                <div id="chat-messages" class="chat-messages h-96 overflow-y-auto p-6 space-y-4">
                    <!-- Welcome Message -->
                    <div class="message-bot rounded-2xl p-4 max-w-md animate-fade-in">
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-robot text-sm"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm text-gray-400 mb-1">Assistente PIX</div>
                                <div class="text-gray-100">
                                    üëã Ol√°! Sou seu assistente especializado em comprovantes PIX. 
                                    <br><br>
                                    Posso ajudar voc√™ a:
                                    <ul class="mt-2 space-y-1 text-sm">
                                        <li>üìÑ Extrair dados de comprovantes</li>
                                        <li>üí∞ Analisar valores e destinat√°rios</li>
                                        <li>üîç Responder perguntas sobre transa√ß√µes</li>
                                        <li>üìä Gerar relat√≥rios estruturados</li>
                                    </ul>
                                    <br>
                                    <strong>Envie um comprovante ou fa√ßa uma pergunta!</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div id="typing-indicator" class="hidden px-6 pb-4">
                    <div class="message-bot rounded-2xl p-4 max-w-md typing-indicator">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-sm"></i>
                            </div>
                            <div class="ml-3 flex space-x-1">
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input Area -->
                <div class="bg-dark-800 border-t border-gray-700 p-4">
                    <!-- File Upload Area (Mini) -->
                    <div id="file-upload-area" class="mb-4 hidden">
                        <div class="file-drop-mini rounded-lg p-4 text-center">
                            <i class="fas fa-cloud-upload-alt text-2xl text-primary mb-2"></i>
                            <p class="text-sm text-gray-400">Arraste um comprovante aqui ou clique para selecionar</p>
                            <input type="file" id="file-input-chat" class="hidden" accept="image/*, .pdf">
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="flex items-end space-x-3">
                        <button id="attach-btn" class="p-3 text-gray-400 hover:text-primary hover:bg-gray-700 rounded-lg transition">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>
                        
                        <div class="flex-1 relative">
                            <textarea 
                                id="chat-input" 
                                placeholder="Digite sua pergunta ou envie um comprovante PIX..."
                                class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none min-h-[48px] max-h-32"
                                rows="1"
                            ></textarea>
                            <button id="send-btn" class="absolute right-2 bottom-2 p-2 bg-gradient-to-r from-primary to-secondary rounded-lg hover:opacity-90 transition disabled:opacity-50" disabled>
                                <i class="fas fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                        
                        <button id="voice-btn" class="p-3 text-gray-400 hover:text-green-400 hover:bg-gray-700 rounded-lg transition">
                            <i class="fas fa-microphone text-lg"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between mt-3 text-xs text-gray-500">
                        <div class="flex items-center space-x-4">
                            <span>Pressione Enter para enviar</span>
                            <span>Shift + Enter para nova linha</span>
                        </div>
                        <div id="char-count">0/500</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions/Suggestions -->
            <div class="mt-6 flex flex-wrap gap-3 justify-center">
                <button class="quick-action bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm transition">
                    üí∞ "Qual o valor total das minhas transa√ß√µes?"
                </button>
                <button class="quick-action bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm transition">
                    üìä "Gere um relat√≥rio dos meus PIX"
                </button>
                <button class="quick-action bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm transition">
                    üîç "Analise este comprovante"
                </button>
                <button class="quick-action bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm transition">
                    ‚ùì "Como funciona a extra√ß√£o?"
                </button>
            </div>
        </div>
    </main>
    
    <script>
        class PIXChatbot {
            constructor() {
                this.messagesContainer = document.getElementById('chat-messages');
                this.chatInput = document.getElementById('chat-input');
                this.sendBtn = document.getElementById('send-btn');
                this.attachBtn = document.getElementById('attach-btn');
                this.fileInput = document.getElementById('file-input-chat');
                this.fileUploadArea = document.getElementById('file-upload-area');
                this.typingIndicator = document.getElementById('typing-indicator');
                this.charCount = document.getElementById('char-count');
                this.clearBtn = document.getElementById('clear-chat');
                
                // REAL DATA - Dados reais extra√≠dos da API
                this.extractedDataHistory = []; // Hist√≥rico de comprovantes processados
                this.currentFile = null;
                this.conversationHistory = [];
                
                this.init();
            }
            
            init() {
                // Event listeners
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.chatInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
                this.chatInput.addEventListener('input', () => this.handleInputChange());
                this.attachBtn.addEventListener('click', () => this.toggleFileUpload());
                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.clearBtn.addEventListener('click', () => this.clearChat());
                
                // Quick actions
                document.querySelectorAll('.quick-action').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const text = e.target.textContent.replace(/[üí∞üìäüîç‚ùì] "(.+)"/, '$1');
                        this.chatInput.value = text;
                        this.handleInputChange();
                        this.sendMessage();
                    });
                });
                
                // File drag and drop
                this.setupFileDragDrop();
            }
            
            handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            }
            
            handleInputChange() {
                const text = this.chatInput.value;
                const length = text.length;
                
                this.charCount.textContent = `${length}/500`;
                this.sendBtn.disabled = length === 0;
                
                if (length > 500) {
                    this.charCount.classList.add('text-red-400');
                } else {
                    this.charCount.classList.remove('text-red-400');
                }
                
                // Auto-resize textarea
                this.chatInput.style.height = 'auto';
                this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 128) + 'px';
            }
            
            toggleFileUpload() {
                const isHidden = this.fileUploadArea.classList.contains('hidden');
                if (isHidden) {
                    this.fileUploadArea.classList.remove('hidden');
                    this.attachBtn.classList.add('text-primary');
                } else {
                    this.fileUploadArea.classList.add('hidden');
                    this.attachBtn.classList.remove('text-primary');
                }
            }
            
            setupFileDragDrop() {
                const dropArea = this.fileUploadArea.querySelector('.file-drop-mini');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.style.backgroundColor = 'rgba(139, 92, 246, 0.1)';
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.style.backgroundColor = 'transparent';
                    });
                });
                
                dropArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    this.handleFiles(files);
                });
                
                dropArea.addEventListener('click', () => {
                    this.fileInput.click();
                });
            }
            
            handleFileUpload(e) {
                const files = e.target.files;
                this.handleFiles(files);
            }
            
            handleFiles(files) {
                if (files.length === 0) return;
                
                const file = files[0];
                if (!file.type.match(/(image\/(jpeg|png)|application\/pdf)/)) {
                    this.addMessage('bot', '‚ùå Por favor, envie apenas arquivos de imagem (JPG, PNG) ou PDF.');
                    return;
                }
                
                // Add user message with file
                this.addMessage('user', `üìé Enviou: ${file.name}`, file);
                
                // Hide file upload area
                this.fileUploadArea.classList.add('hidden');
                this.attachBtn.classList.remove('text-primary');
                
                // Process file
                this.processFile(file);
            }
            
            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message) return;
                
                // Add user message
                this.addMessage('user', message);
                
                // Clear input
                this.chatInput.value = '';
                this.handleInputChange();
                
                // Process message
                await this.processMessage(message);
            }
            
            async processMessage(message) {
                this.showTyping();
                
                // Simulate processing delay
                await this.delay(800);
                
                let response = '';
                
                // INTENT RECOGNITION MELHORADO
                try {
                    if (this.isGreeting(message)) {
                        response = this.getGreetingResponse();
                    } else if (this.isValueQuery(message)) {
                        response = this.getRealValueResponse();
                    } else if (this.isDateQuery(message)) {
                        response = this.getDateResponse();
                    } else if (this.isRecipientQuery(message)) {
                        response = this.getRecipientResponse();
                    } else if (this.isSenderQuery(message)) {
                        response = this.getSenderResponse();
                    } else if (this.isBankQuery(message)) {
                        response = this.getBankResponse();
                    } else if (this.isCPFQuery(message)) {
                        response = this.getCPFResponse();
                    } else if (this.isTransactionIDQuery(message)) {
                        response = this.getTransactionIDResponse();
                    } else if (this.isReportRequest(message)) {
                        response = this.getRealReportResponse();
                    } else if (this.isComparisonRequest(message)) {
                        response = this.getComparisonResponse();
                    } else if (this.isStatsRequest(message)) {
                        response = this.getStatsResponse();
                    } else if (this.isQuestion(message)) {
                        response = this.getRealQuestionResponse(message);
                    } else {
                        response = this.getDefaultResponse(message);
                    }
                } catch (error) {
                    console.error('Erro no processamento da mensagem:', error);
                    response = '‚ùå Desculpe, ocorreu um erro ao processar sua mensagem. Tente novamente.';
                }
                
                this.hideTyping();
                this.addMessage('bot', response);
            }
            
            async processFile(file) {
                this.showTyping();
                this.currentFile = file;
                
                try {
                    // REAL API CALL - Chamada real para a API
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // Fazer chamada real para a API
                    const response = await fetch('/api/extract', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === 'success' || result.status === 'partial') {
                        // DADOS REAIS extra√≠dos
                        const dadosReais = result.dados_estruturados || {};
                        const nomes = result.nomes || {};
                        const textoExtraido = result.texto_extraido || {};
                        
                        // Estruturar dados reais para o chatbot
                        const novoComprovante = {
                            id: Date.now(),
                            arquivo: file.name,
                            banco: result.banco_identificado || 'N√£o identificado',
                            valor: dadosReais.valor || 'N√£o extra√≠do',
                            data: dadosReais.data || 'N√£o extra√≠do',
                            destinatario: dadosReais.destinatario || nomes.destinatario || 'N√£o extra√≠do',
                            remetente: dadosReais.remetente || nomes.remetente || 'N√£o extra√≠do',
                            cpfs: dadosReais.cpfs || [],
                            id_transacao: dadosReais.id_transacao || 'N√£o extra√≠do',
                            score: result.score_extracao || 0,
                            texto_completo: textoExtraido.tesseract || '',
                            timestamp: new Date(),
                            processing_info: result.processing_info || {}
                        };
                        
                        this.extractedDataHistory.push(novoComprovante);
                        
                        const response = this.getRealExtractionResponse(novoComprovante);
                        
                        this.hideTyping();
                        this.addMessage('bot', response);
                        
                    } else {
                        throw new Error(result.erro || 'Erro na extra√ß√£o');
                    }
                    
                } catch (error) {
                    console.error('Erro na extra√ß√£o:', error);
                    this.hideTyping();
                    
                    let errorMessage = '';
                    if (error.message.includes('500')) {
                        errorMessage = '‚ùå <strong>Erro interno do servidor</strong><br><br>Tente novamente em alguns segundos. O sistema pode estar processando muitos arquivos.';
                    } else if (error.message.includes('400')) {
                        errorMessage = '‚ùå <strong>Arquivo n√£o suportado</strong><br><br>Por favor, envie apenas imagens (JPG, PNG) ou PDFs de comprovantes PIX v√°lidos.';
                    } else {
                        errorMessage = `‚ùå <strong>Erro no processamento</strong><br><br>${error.message}<br><br>üí° <strong>Dicas:</strong><br>‚Ä¢ Verifique se √© um comprovante PIX<br>‚Ä¢ Certifique-se que a imagem est√° leg√≠vel<br>‚Ä¢ Tente redimensionar o arquivo`;
                    }
                    
                    this.addMessage('bot', errorMessage);
                }
            }
            
            // Response generators com DADOS REAIS
            getRealExtractionResponse(dadosReais) {
                const scoreColor = dadosReais.score > 0.7 ? 'text-green-400' : dadosReais.score > 0.4 ? 'text-yellow-400' : 'text-red-400';
                const processingTime = dadosReais.processing_info.total_request_time_seconds || 'N/A';
                
                return `‚úÖ <strong>Comprovante processado com sucesso!</strong>
                
                <div class="bg-gray-800 p-3 rounded-lg mt-3 mb-4">
                    <div class="flex justify-between items-center text-sm">
                        <span>üìÅ <strong>${dadosReais.arquivo}</strong></span>
                        <div class="flex items-center space-x-4">
                            <span class="text-blue-400">‚ö° ${processingTime}s</span>
                            <span class="${scoreColor}">üìä ${(dadosReais.score * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="extracted-data mt-4 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-blue-300">üìä Dados Extra√≠dos (REAIS):</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div><strong>üè¶ Banco:</strong> <span class="text-yellow-400">${dadosReais.banco}</span></div>
                        <div><strong>üí∞ Valor:</strong> <span class="text-green-400">${dadosReais.valor}</span></div>
                        <div><strong>üìÖ Data:</strong> ${dadosReais.data}</div>
                        <div><strong>üë§ Destinat√°rio:</strong> ${dadosReais.destinatario}</div>
                        <div><strong>üè¶ Remetente:</strong> ${dadosReais.remetente}</div>
                        ${dadosReais.cpfs.length > 0 ? `<div><strong>üìÑ CPFs:</strong> ${dadosReais.cpfs.join(', ')}</div>` : ''}
                        ${dadosReais.id_transacao !== 'N√£o extra√≠do' ? `<div class="md:col-span-2"><strong>üî¢ ID:</strong> <code class="text-xs">${dadosReais.id_transacao}</code></div>` : ''}
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-green-900/20 border border-green-500/30 rounded-lg">
                    <div class="text-sm text-green-300">
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Processamento conclu√≠do!</strong> Agora voc√™ pode fazer perguntas sobre este comprovante.
                    </div>
                </div>
                
                <div class="mt-3 text-sm text-gray-400">
                    üí° <strong>Experimente perguntar:</strong><br>
                    ‚Ä¢ "Qual foi o valor desta transa√ß√£o?"<br>
                    ‚Ä¢ "Quem √© o destinat√°rio?"<br>
                    ‚Ä¢ "Qual banco foi usado?"<br>
                    ‚Ä¢ "Gere um relat√≥rio completo"
                </div>`;
            }
            
            getRealQuestionResponse(message) {
                if (this.extractedDataHistory.length === 0) {
                    return 'ü§î Para responder suas perguntas, preciso primeiro analisar um comprovante. Envie um arquivo PIX!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                const lowerMessage = message.toLowerCase();
                
                // Detectar tipo espec√≠fico de pergunta
                if (this.isValueQuery(message)) {
                    return this.getRealValueResponse();
                } else if (this.isDateQuery(message)) {
                    return this.getDateResponse();
                } else if (this.isRecipientQuery(message)) {
                    return this.getRecipientResponse();
                } else if (this.isSenderQuery(message)) {
                    return this.getSenderResponse();
                } else if (this.isBankQuery(message)) {
                    return this.getBankResponse();
                } else if (this.isCPFQuery(message)) {
                    return this.getCPFResponse();
                } else if (this.isTransactionIDQuery(message)) {
                    return this.getTransactionIDResponse();
                }
                
                // Resposta gen√©rica se n√£o detectar tipo espec√≠fico
                return `ü§ñ <strong>Sobre o √∫ltimo comprovante:</strong><br>
                üí∞ Valor: ${ultimoComprovante.valor}<br>
                üë§ Destinat√°rio: ${ultimoComprovante.destinatario}<br>
                üè¶ Banco: ${ultimoComprovante.banco}<br>
                üìÖ Data: ${ultimoComprovante.data}<br><br>
                <strong>Seja mais espec√≠fico:</strong> "Qual o valor?", "Quem √© o destinat√°rio?", etc.`;
            }
            
            getRealValueResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üí∞ Envie um comprovante primeiro para eu analisar os valores!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                
                // Calcular estat√≠sticas se houver m√∫ltiplos comprovantes
                if (this.extractedDataHistory.length > 1) {
                    const valores = this.extractedDataHistory
                        .map(c => c.valor)
                        .filter(v => v !== 'N√£o extra√≠do')
                        .map(v => this.extractValueNumber(v))
                        .filter(v => !isNaN(v));
                    
                    if (valores.length > 0) {
                        const total = valores.reduce((a, b) => a + b, 0);
                        const media = total / valores.length;
                        
                        return `üí∞ <strong>An√°lise de Valores:</strong>
                        
                        <div class="bg-gray-800 p-4 rounded-lg mt-3">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>üí∞ √öltimo valor:</strong> ${ultimoComprovante.valor}</div>
                                <div><strong>üìä Total processado:</strong> R$ ${total.toFixed(2)}</div>
                                <div><strong>üìà Valor m√©dio:</strong> R$ ${media.toFixed(2)}</div>
                                <div><strong>üìÑ Comprovantes:</strong> ${this.extractedDataHistory.length}</div>
                            </div>
                        </div>`;
                    }
                }
                
                return `üí∞ O valor da √∫ltima transa√ß√£o analisada √© <strong>${ultimoComprovante.valor}</strong>
                
                <div class="mt-2 text-sm text-gray-400">
                    üìÅ Arquivo: ${ultimoComprovante.arquivo}<br>
                    üè¶ Banco: ${ultimoComprovante.banco}
                </div>`;
            }
            
            getDateResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üìÖ Envie um comprovante primeiro para analisar a data!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                return `üìÖ A transa√ß√£o foi realizada em <strong>${ultimoComprovante.data}</strong>
                
                <div class="mt-2 text-sm text-gray-400">
                    ‚è∞ Processado em: ${ultimoComprovante.timestamp.toLocaleString()}<br>
                    üìÅ Arquivo: ${ultimoComprovante.arquivo}
                </div>`;
            }
            
            getRecipientResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üë§ Envie um comprovante primeiro para identificar o destinat√°rio!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                return `üë§ O destinat√°rio da transa√ß√£o √© <strong>${ultimoComprovante.destinatario}</strong>
                
                ${ultimoComprovante.cpfs.length > 0 ? `<div class="mt-2 text-sm text-gray-400">üìÑ CPF: ${ultimoComprovante.cpfs[0]}</div>` : ''}
                
                <div class="mt-2 text-sm text-gray-400">
                    üí∞ Valor: ${ultimoComprovante.valor}<br>
                    üè¶ Banco: ${ultimoComprovante.banco}
                </div>`;
            }
            
            getSenderResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üè¶ Envie um comprovante primeiro para identificar o remetente!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                return `üè¶ O remetente da transa√ß√£o √© <strong>${ultimoComprovante.remetente}</strong>
                
                <div class="mt-2 text-sm text-gray-400">
                    üë§ Para: ${ultimoComprovante.destinatario}<br>
                    üí∞ Valor: ${ultimoComprovante.valor}
                </div>`;
            }
            
            getBankResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üè¶ Envie um comprovante primeiro para identificar o banco!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                return `üè¶ O banco identificado foi <strong>${ultimoComprovante.banco}</strong>
                
                <div class="mt-2 text-sm text-gray-400">
                    üìä Confian√ßa: ${(ultimoComprovante.score * 100).toFixed(1)}%<br>
                    ‚ö° Tempo de processamento: ${ultimoComprovante.processing_info.total_request_time_seconds || 'N/A'}s<br>
                    üí∞ Valor: ${ultimoComprovante.valor}
                </div>`;
            }
            
            getCPFResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üì± Envie um comprovante primeiro para extrair CPFs!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                
                if (ultimoComprovante.cpfs.length === 0) {
                    return `üì± Nenhum CPF foi extra√≠do do √∫ltimo comprovante.
                    
                    <div class="mt-2 text-sm text-gray-400">
                        Isso pode acontecer se o comprovante n√£o cont√©m CPFs vis√≠veis ou se a qualidade da imagem est√° baixa.
                    </div>`;
                }
                
                return `üì± <strong>CPFs/CNPJs encontrados:</strong>
                
                <div class="bg-gray-800 p-3 rounded-lg mt-2">
                    ${ultimoComprovante.cpfs.map(cpf => `<div class="font-mono text-sm">${cpf}</div>`).join('')}
                </div>
                
                <div class="mt-2 text-sm text-gray-400">
                    üë§ Destinat√°rio: ${ultimoComprovante.destinatario}
                </div>`;
            }
            
            getTransactionIDResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üî¢ Envie um comprovante primeiro para extrair o ID da transa√ß√£o!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                
                if (ultimoComprovante.id_transacao === 'N√£o extra√≠do') {
                    return `üî¢ O ID da transa√ß√£o n√£o foi extra√≠do do √∫ltimo comprovante.
                    
                    <div class="mt-2 text-sm text-gray-400">
                        Isso pode acontecer se o ID n√£o est√° vis√≠vel ou leg√≠vel na imagem.
                    </div>`;
                }
                
                return `üî¢ <strong>ID da transa√ß√£o:</strong>
                
                <div class="bg-gray-800 p-3 rounded-lg mt-2 font-mono text-sm">
                    ${ultimoComprovante.id_transacao}
                </div>
                
                <div class="mt-2 text-sm text-gray-400">
                    üí∞ Valor: ${ultimoComprovante.valor}<br>
                    üìÖ Data: ${ultimoComprovante.data}
                </div>`;
            }
            
            getRealReportResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üìä Preciso de pelo menos um comprovante para gerar um relat√≥rio!';
                }
                
                const ultimoComprovante = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                const agora = new Date();
                
                return `üìä <strong>Relat√≥rio PIX Detalhado</strong>
                
                <div class="bg-gray-800 p-4 rounded-lg mt-3 font-mono text-sm">
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê<br>
                    üìÑ <strong>RELAT√ìRIO OFICIAL - PIXText.ai</strong><br>
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê<br>
                    üìÖ Gerado em: ${agora.toLocaleString()}<br>
                    üìÅ Arquivo: ${ultimoComprovante.arquivo}<br>
                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br>
                    üè¶ Banco: ${ultimoComprovante.banco}<br>
                    üí∞ Valor: ${ultimoComprovante.valor}<br>
                    üìÖ Data Transa√ß√£o: ${ultimoComprovante.data}<br>
                    üë§ De: ${ultimoComprovante.remetente}<br>
                    üë§ Para: ${ultimoComprovante.destinatario}<br>
                    ${ultimoComprovante.cpfs.length > 0 ? `üìÑ CPF: ${ultimoComprovante.cpfs[0]}<br>` : ''}
                    üî¢ ID: ${ultimoComprovante.id_transacao}<br>
                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br>
                    üìä Score Extra√ß√£o: ${(ultimoComprovante.score * 100).toFixed(1)}%<br>
                    ‚ö° Tempo Processamento: ${ultimoComprovante.processing_info.total_request_time_seconds || 'N/A'}s<br>
                    ü§ñ Tecnologia: OCR + ML <br>
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                </div>
                
                <div class="mt-3 text-xs text-gray-500">
                    üíæ Dados extra√≠dos automaticamente via Intelig√™ncia Artificial
                </div>`;
            }
            
            getComparisonResponse() {
                if (this.extractedDataHistory.length < 2) {
                    return 'üìä Preciso de pelo menos 2 comprovantes para fazer compara√ß√µes. Envie mais arquivos!';
                }
                
                const ultimo = this.extractedDataHistory[this.extractedDataHistory.length - 1];
                const penultimo = this.extractedDataHistory[this.extractedDataHistory.length - 2];
                
                return `üìä <strong>Compara√ß√£o entre √öltimas Transa√ß√µes:</strong>
                
                <div class="bg-gray-800 p-4 rounded-lg mt-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <strong class="text-blue-300">üìÑ Comprovante Atual:</strong><br>
                            üí∞ ${ultimo.valor}<br>
                            üè¶ ${ultimo.banco}<br>
                            üìÖ ${ultimo.data}<br>
                            üë§ ${ultimo.destinatario}
                        </div>
                        <div>
                            <strong class="text-yellow-300">üìÑ Comprovante Anterior:</strong><br>
                            üí∞ ${penultimo.valor}<br>
                            üè¶ ${penultimo.banco}<br>
                            üìÖ ${penultimo.data}<br>
                            üë§ ${penultimo.destinatario}
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 text-sm text-gray-400">
                    üìà Total de comprovantes processados: <strong>${this.extractedDataHistory.length}</strong>
                </div>`;
            }
            
            getStatsResponse() {
                if (this.extractedDataHistory.length === 0) {
                    return 'üìà Envie comprovantes para eu gerar estat√≠sticas!';
                }
                
                const bancos = {};
                const valores = [];
                
                this.extractedDataHistory.forEach(comprovante => {
                    // Contar bancos
                    bancos[comprovante.banco] = (bancos[comprovante.banco] || 0) + 1;
                    
                    // Coletar valores
                    const valor = this.extractValueNumber(comprovante.valor);
                    if (!isNaN(valor)) valores.push(valor);
                });
                
                const bancoMaisFrequente = Object.keys(bancos).reduce((a, b) => bancos[a] > bancos[b] ? a : b);
                const totalValor = valores.reduce((a, b) => a + b, 0);
                const mediaValor = valores.length > 0 ? totalValor / valores.length : 0;
                
                return `üìà <strong>Estat√≠sticas dos Comprovantes:</strong>
                
                <div class="bg-gray-800 p-4 rounded-lg mt-3">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>üìÑ Total processados:</strong> ${this.extractedDataHistory.length}</div>
                        <div><strong>üè¶ Banco mais usado:</strong> ${bancoMaisFrequente}</div>
                        <div><strong>üí∞ Valor total:</strong> R$ ${totalValor.toFixed(2)}</div>
                        <div><strong>üìä Valor m√©dio:</strong> R$ ${mediaValor.toFixed(2)}</div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <strong class="text-blue-300">üè¶ Distribui√ß√£o por Bancos:</strong><br>
                        ${Object.entries(bancos).map(([banco, count]) => 
                            `<span class="inline-block bg-gray-700 px-2 py-1 rounded text-xs mr-2 mt-1">${banco}: ${count}</span>`
                        ).join('')}
                    </div>
                </div>`;
            }
            
            getGreetingResponse() {
                const greetings = [
                    'üëã Ol√°! Como posso ajudar com seus comprovantes PIX hoje?',
                    'üòä Oi! Pronto para analisar alguns comprovantes?',
                    'üéâ Bem-vindo! Vamos come√ßar a extrair dados dos seus PIX?'
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }
            
            getDefaultResponse(message) {
                const responses = [
                    'ü§ñ Interessante! Mas foque em perguntas sobre comprovantes PIX. Como posso ajudar?',
                    'üí° Estou aqui para an√°lise de PIX. Envie um comprovante ou fa√ßa perguntas espec√≠ficas!',
                    'üéØ Minha especialidade s√£o comprovantes PIX. O que voc√™ gostaria de saber?'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // UTILITY FUNCTIONS PARA DETEC√á√ÉO DE INTENTS
            isGreeting(message) {
                const greetingWords = ['oi', 'ol√°', 'hello', 'ola', 'bom dia', 'boa tarde', 'boa noite', 'e ai', 'eae'];
                return greetingWords.some(word => message.toLowerCase().includes(word));
            }
            
            isQuestion(message) {
                return message.includes('?') || 
                       ['o que', 'qual', 'como', 'quando', 'onde', 'quem', 'quanto', 'por que', 'porque'].some(word => 
                           message.toLowerCase().includes(word));
            }
            
            isValueQuery(message) {
                const valueWords = ['valor', 'pre√ßo', 'preco', 'quanto', 'dinheiro', 'total', 'quantia', 'grana'];
                return valueWords.some(word => message.toLowerCase().includes(word));
            }
            
            isDateQuery(message) {
                const dateWords = ['data', 'quando', 'dia', 'horario', 'hor√°rio', 'tempo', 'momento'];
                return dateWords.some(word => message.toLowerCase().includes(word));
            }
            
            isRecipientQuery(message) {
                const recipientWords = ['destinatario', 'destinat√°rio', 'recebeu', 'para quem', 'quem recebeu', 'beneficiario', 'benefici√°rio'];
                return recipientWords.some(word => message.toLowerCase().includes(word));
            }
            
            isSenderQuery(message) {
                const senderWords = ['remetente', 'enviou', 'de quem', 'quem enviou', 'pagador', 'origem'];
                return senderWords.some(word => message.toLowerCase().includes(word));
            }
            
            isBankQuery(message) {
                const bankWords = ['banco', 'institui√ß√£o', 'instituicao', 'financeira'];
                return bankWords.some(word => message.toLowerCase().includes(word));
            }
            
            isCPFQuery(message) {
                const cpfWords = ['cpf', 'cnpj', 'documento', 'identificacao', 'identifica√ß√£o'];
                return cpfWords.some(word => message.toLowerCase().includes(word));
            }
            
            isTransactionIDQuery(message) {
                const idWords = ['id', 'codigo', 'c√≥digo', 'transacao', 'transa√ß√£o', 'identificador'];
                return idWords.some(word => message.toLowerCase().includes(word));
            }
            
            isReportRequest(message) {
                const reportWords = ['relat√≥rio', 'relatorio', 'resumo', 'report', 'detalhado'];
                return reportWords.some(word => message.toLowerCase().includes(word));
            }
            
            isComparisonRequest(message) {
                const comparisonWords = ['comparar', 'compare', 'diferen√ßa', 'diferenca', 'anterior', '√∫ltimo', 'ultimo'];
                return comparisonWords.some(word => message.toLowerCase().includes(word));
            }
            
            isStatsRequest(message) {
                const statsWords = ['estat√≠sticas', 'estatisticas', 'resumo', 'total', 'm√©dia', 'media', 'stats'];
                return statsWords.some(word => message.toLowerCase().includes(word));
            }
            
            // Utility functions
            extractValueNumber(valorStr) {
                if (valorStr === 'N√£o extra√≠do') return NaN;
                const numbers = valorStr.replace(/[^\d,]/g, '').replace(',', '.');
                return parseFloat(numbers);
            }
            
            addMessage(sender, content, file = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `animate-fade-in ${sender === 'user' ? 'flex justify-end' : ''}`;
                
                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="message-user rounded-2xl p-4 max-w-md">
                            <div class="text-white">
                                ${file ? `<div class="flex items-center mb-2"><i class="fas fa-file mr-2"></i><span class="text-sm">${file.name}</span></div>` : ''}
                                ${content}
                            </div>
                            <div class="text-xs text-gray-200 mt-2 opacity-70">${new Date().toLocaleTimeString()}</div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-bot rounded-2xl p-4 max-w-2xl">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-sm"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="text-sm text-gray-400 mb-1">Assistente PIX</div>
                                    <div class="text-gray-100">${content}</div>
                                    <div class="text-xs text-gray-500 mt-2">${new Date().toLocaleTimeString()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // Save to history
                this.conversationHistory.push({ sender, content, timestamp: new Date() });
            }
            
            showTyping() {
                this.typingIndicator.classList.remove('hidden');
                this.scrollToBottom();
            }
            
            hideTyping() {
                this.typingIndicator.classList.add('hidden');
            }
            
            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }
            
            clearChat() {
                if (confirm('Deseja limpar toda a conversa e dados extra√≠dos?')) {
                    this.messagesContainer.innerHTML = `
                        <div class="message-bot rounded-2xl p-4 max-w-md animate-fade-in">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-sm"></i>
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm text-gray-400 mb-1">Assistente PIX</div>
                                    <div class="text-gray-100">
                                        üëã Ol√°! Sou seu assistente especializado em comprovantes PIX. 
                                        <br><br>
                                        Posso ajudar voc√™ a:
                                        <ul class="mt-2 space-y-1 text-sm">
                                            <li>üìÑ Extrair dados de comprovantes</li>
                                            <li>üí∞ Analisar valores e destinat√°rios</li>
                                            <li>üîç Responder perguntas sobre transa√ß√µes</li>
                                            <li>üìä Gerar relat√≥rios estruturados</li>
                                        </ul>
                                        <br>
                                        <strong>Envie um comprovante ou fa√ßa uma pergunta!</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Limpar dados reais
                    this.extractedDataHistory = [];
                    this.currentFile = null;
                    this.conversationHistory = [];
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // Initialize chatbot when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new PIXChatbot();
        });
    </script>
</body>
</html>